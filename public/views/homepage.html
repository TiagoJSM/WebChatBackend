<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <title>Chatroom</title>
    </head>

    <body>
        <div id="messages">
            <div id="messages-container"></div>

            <input type="text" id="message-input" />
            <button id="send-message-button">Send</button>
        </div>

        <div id="signup">
            <label>Name:</label>
            <input type="text" id="username" />
            <button id="signup-button">Enter</button>
        </div>

        <script>
            (function() {
                var username;
                var websocket;
                
                var messages = document.getElementById('messages-container');

                var getJSON = function(url, onSuccess, onError) {
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', url, true);
                    xhr.responseType = 'json';
                    xhr.onload = function() {
                        var status = xhr.status;
                        if (status === 200) {
                            onSuccess(xhr.response);
                        } else {
                            onError(status, xhr.response);
                        }
                    };
                    xhr.send();
                };

                function appendMessage(message) {
                    var textnode = document.createTextNode(`${message.Username} [${message.Timestamp}]: ${message.Text}`); 
                    messages.appendChild(textnode);
                }

                function populateChatWindow(messages) {
                    messages.forEach(appendMessage);
                }

                function connectToChatWebsocket() {
                    var loc = window.location;
                    var uri = 'ws:';
                    
                    if (loc.protocol === 'https:') {
                        uri = 'wss:';
                    }
                    uri += '//' + loc.host;
                    uri += loc.pathname + 'ws';

                    websocket = new WebSocket(uri);

                    websocket.onopen = function() {
                        console.log('Connected');
                    }

                    websocket.onmessage = function(evt) {
                        const msg = JSON.parse(event.data);
                        appendMessage(msg);
                    }
                }

                function sucessFetchingMessages(messages) {
                    populateChatWindow(messages);
                    connectToChatWebsocket();
                    document.getElementById('signup').remove();
                    document.getElementById('messages').style.visibility = "visible"
                }

                function errorFetchingMessages(status, messages) {

                }

                function getChatMessages() {
                    getJSON('/messages', sucessFetchingMessages, errorFetchingMessages)
                }

                function signUp() {
                    username = document.getElementById("username").value;

                    getChatMessages();
                }

                function postMessage() {
                    const messageText = document.getElementById("message-input").value;
                    const msg = JSON.stringify({ username: username, text: messageText });
                    websocket.send(msg);
                }

                document.getElementById('signup-button').addEventListener("click", signUp);
                document.getElementById('send-message-button').addEventListener("click", postMessage);
                
            })();
            
        </script>
    </body>

</html>